# eth-tools
Javascript utilities for working with Ethereum.

## Why
A place to collect notes gathered while studying the chain and virtual machine.

## How
Each module can generally be used standalone. Some are only useful in scripts or node programs, others are also useful in a browser or dApp context.

### Dependencies
Some of the modules have dependencies you must inject by importing the config module and setting one or more properties on the object it exports.

```javascript
import { ethers } from 'ethers'
import config from 'eth-tools/config.js'

// ethers.js provider (rpc client)
const provider = new ethers.providers.JsonRpcProvider('http://localhost:3000')

// ethers.js is used by deploy, watchTx, getRevertReason and encodeConstructorArgs
config.ethers = ethers

// provider is used by getRevertReason and watchTx
config.provider = provider
```

### Spawning a node
Spawns geth in dev mode with sane defaults suitable for testing and experimentation.

```javascript
import geth from 'eth-tools/geth.js'

const gethChildProcess = await geth('path/to/geth', {
	datadir: 'path/to/data',
	port: '3000',
	gasLimit: 11500000,
	gasCap: 0
})
```

### Solidity compilation
Pass in a path to a `solc` executable and a standard-input-json like object, get back compiler output json as an object.

```javascript
import compile from 'eth-tools/compile.js'

const compilerOutput = await compile('path/to/solc', {
	sources: {
		'MyContract.sol': {
			urls: ['MyContract.sol']
		}
	}
})
```

### Deploying compiled contracts
Pass in a signer and a javascript object map of contract "templates".

```javascript
import deploy from 'eth-tools/deploy.js'

const providerAccounts = await provider.listAccounts()
const signer = await provider.getSigner(providerAccounts[0])
const templates = {
	MyContract: {
		build: compilerOutput.contracts['MyContract.sol'].MyContract,
		args: [ 'some', 'constructor', 'args' ],
		preDeploy: (currentTemplate, allTemplates) => {},
		postDeploy: (currentTemplate, allTemplates) => {}
	}
}
await deploy(signer, templates)
console.log(templates.MyContract.contract.functions)
```

### Watch a transaction until it has been mined
Awaits an ethers.js transaction and attempts to handle errors during its lifecycle whether they are generated by the rpc client, an eth node, or an on chain reversion. If the transcation was mined but also reverted, `getRevertReason` is invoked internally to synthesize the reason.

```javascript
import watchTx from 'eth-tools/watch-tx.js'

try {
	const tx = templates.MyContract.contract.someMethodThatModifiesState()
	await watchTx(tx)
	console.log('transaction successful')
} catch (err) {
	console.log('transaction failed', err)
}
```

### Getting the reason a transaction was reverted
If a transaction was reverted, this module can simulate the execution failure using `eth_call` to synthesize the reason.

```javascript
import getRevertReason from 'eth-tools/get-revert-reason.js'

const tx = templates.MyContract.contract.someMethodThatModifiesState()
await tx // assume transaction is sent and mined but reverts on chain
const reason = getRevertReason(tx)
```

### Encoding constructor arguments
Useful for verifying contracts on Etherscan.

```javascript
import encodeConstructorArgs from 'eth-tools/encode-constructor-args.js'

const abi = compilerOutput.contracts['MyContract.sol'].MyContract.abi
const encodedArgs = encodeConstructorArgs(abi, [ 'some', 'constructor', 'args' ])
```

### Generating standard-input-json
Useful for verifying contracts on Etherscan.

```javascript
import generateStandardInputJson from 'eth-tools/generate-standard-input-json.js'

const solcSettings = compile.defaultSettings
const standardInputJson = generateStandardInputJson(solcSettings, {
	'MyContract.sol': {
		urls: ['MyContract.sol']
	}
})
```

## License
MIT
